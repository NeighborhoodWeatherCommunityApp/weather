<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>날씨 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
          crossorigin="anonymous">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">

    <!-- Icons -->
    <link href="/assets/css/nucleo-icons.css" rel="stylesheet"/>
    <link href="/assets/css/nucleo-svg.css" rel="stylesheet"/>

    <!-- CSS Files -->
    <link id="pagestyle" href="/assets/css/argon-dashboard.css" rel="stylesheet"/>

    <style>
        .icon {
            display: flex; /* 자식 요소를 flex 컨테이너로 설정 */
            justify-content: center; /* 가로 정렬: 가운데 */
            align-items: center; /* 세로 정렬: 가운데 */
            height: 100%; /* 부모 높이에 맞춤 */
            width: 100%; /* 부모 너비에 맞춤 */
        }

        .icon img {
            max-width: 100%; /* 아이콘 크기 조정 가능 */
            max-height: 100%; /* 이미지가 부모 높이를 넘지 않도록 */
        }

        .icon-shape {
            position: relative;
            width: 46px; /* 원하는 크기로 설정 */
            height: 46px;
        }
    </style>
</head>

<body class="g-sidenav-show bg-gray-100" th:classappend="${bodyClass}">
<div class="min-height-300 bg-primary position-absolute w-100"></div>
<!-- Sidebar -->
<main class="main-content position-relative border-radius-lg">
    <!-- Navbar -->
    <nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur"
         navbar-scroll="true">
        <!-- Navbar content -->
    </nav>
    <!-- End Navbar -->
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                <div class="card">
                    <div class="card-body p-3" style="height: 120px;">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">공유된 날씨 수</p>
                                    <p class="font-weight-bolder" style="margin-bottom: 0px;"
                                       th:text="${sharedWeatherCount}"></p>
                                    <p class="mb-0">
                                            <span class="text-success text-sm font-weight-bolder"
                                                  th:text="${sharedWeatherIncrease}"></span>
                                    </p>
                                </div>
                            </div>
                            <div class="col-4 text-end" style="width: 74px; height: 74px;">
                                <div class="icon icon-shape bg-gradient-primary shadow-primary text-center rounded-circle">
                                    <img src="/assets/img/small-logos/light-bulb.svg" width="24"
                                         height="24"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                <div class="card">
                    <div class="card-body p-3" style="height: 120px;">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">최다 응답</p>
                                    <p class="mb-0">
                                            <span class="text-success text-sm font-weight-bolder"
                                                  th:text="${countUser}"></span>
                                        명의 사용자들이
                                        <span class="text-success text-sm font-weight-bolder"
                                              th:text="${mostSelectTempTag}"></span>
                                        이라고 응답하였습니다.
                                    </p>
                                </div>
                            </div>
                            <div class="col-4 text-end" style="width: 74px; height: 74px;">
                                <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle">
                                    <img src="/assets/img/small-logos/megaphone.svg" width="24"
                                         height="24"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                <div class="card">
                    <div class="card-body p-3" style="height: 120px;">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-uppercase font-weight-bold">최다 유형</p>
                                    <p class="mb-0">
                                            <span class="text-success text-sm font-weight-bolder"
                                                  th:text="${mostSelectTypeCount}"></span>
                                        명이
                                        <span class="text-success text-sm font-weight-bolder"
                                              th:text="${mostSelectType}"></span>
                                        유형을 선택했습니다.
                                    </p>
                                </div>
                            </div>
                            <div class="col-4 text-end" style="width: 74px; height: 74px;">
                                <div class="icon icon-shape bg-gradient-danger shadow-danger text-center rounded-circle">
                                    <img src="/assets/img/small-logos/person.svg" width="24" height="24"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
                <div class="row" style="width: 320px; height: auto;">
                    <div class="col-8 text-end">
                        <img src="/assets/img/app_icon.png" style="width: 120px; height: auto;">
                    </div>
                </div>
            </div>
            <div class="row mt-4">
                <div class="col-lg-7 mb-lg-0 mb-4">
                    <div class="card z-index-2 h-100">
                        <div class="card-header pb-0 pt-3 bg-transparent">
                            <h6 class="text-capitalize">시간대별 응답</h6>
                            <p class="text-sm mb-0">
                                <span class="font-weight-bold">유형</span>
                            </p>
                            <button type="button" class="btn btn-default" onclick="updateChart(0)">ALL</button>
                            <button type="button" class="btn btn-info" onclick="updateChart(1)">추위</button>
                            <button type="button" class="btn btn-success" onclick="updateChart(2)">보통</button>
                            <button type="button" class="btn btn-danger" onclick="updateChart(3)">더위</button>
                        </div>
                        <div class="card-body p-3">
                            <div class="chart">
                                <canvas id="chart-line" class="chart-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-5">
                    <div class="col-lg-7 mb-lg-0 mb-4" style="height: 100%; width: 100%; position: relative;">
                        <div class="card z-index-2 h-100">
                            <div class="card-header pb-0 pt-3 bg-transparent">
                                <h6 class="text-capitalize">체감 온도와 사용자 응답</h6>
                                <p class="text-sm mb-0">
                                    <span class="font-weight-bold">사용자의 체감 범주와 체감 온도</span>
                                </p>
                            </div>
                            <div class="card-body p-3">
                                <div class="chart">
                                    <canvas id="chart-perceived" class="chart-canvas"
                                            style="display: block; width: 100%; height: 100%;"
                                    ></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <footer class="footer pt-3">
                <!-- Footer content -->
            </footer>
        </div>
    </div>
</main>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/perfect-scrollbar@1.5.0/dist/perfect-scrollbar.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script th:src="@{/assets/js/argon-dashboard.min.js}"></script>

<!-- Font Awesome Icons -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous">
</script>
<script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
<!-- Core -->
<script th:src="@{/assets/js/core/popper.min.js}"></script>
<script th:src="@{/assets/js/core/bootstrap.min.js}"></script>


<script th:inline="javascript">
    var Charts = {
        colors: {
            gray: {
                100: '#f6f9fc',
                200: '#e9ecef',
                300: '#dee2e6',
                400: '#ced4da',
                500: '#adb5bd',
                600: '#8898aa',
                700: '#525f7f',
                800: '#32325d',
                900: '#212529'
            },
            theme: {
                'default': '#172b4d',
                'primary': '#5e72e4',
                'secondary': '#f4f5f7',
                'info': '#11cdef',
                'success': '#2dce89',
                'danger': '#f5365c',
                'warning': '#fb6340'
            }
        }
    };

    var chartLine; // 전역 변수 선언
    let scatterData = [];

    // 서버에서 전달된 데이터로 초기화
    var initialData = {
        times: [[${times}]],
        temps: [[${temps}]],
        tag1: [[${tag1}]],
        tag2: [[${tag2}]],
        tag3: [[${tag3}]],
        tagData1: [[${tagData1}]],
        tagData2: [[${tagData2}]],
        tagData3: [[${tagData3}]]
    };

    var perceivedChart; // 전역 변수 선언

    // 서버에서 전달된 체감 데이터로 초기화
    var initialPerceivedData = {
        tag: [[${tags}]], // 체감 범주 (추움, 더움 등)
        windChillTemp: [[${windChillTemps}]] // 계산된 체감 온도
    };

    $(document).ready(function () {
        // 차트 초기화
        var ctx = document.getElementById('chart-line').getContext('2d');
        chartLine = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    {
                        type: 'line',
                        label: '온도',
                        data: [],
                        borderColor: Charts.colors.theme['primary'],
                        backgroundColor: 'rgba(94, 114, 228, 0.1)',
                        yAxisID: 'y-axis-temp'
                    },
                    {
                        type: 'bar',
                        label: '',
                        data: [],
                        backgroundColor: Charts.colors.theme['default'],
                        yAxisID: 'y-axis-count'
                    },
                    {
                        type: 'bar',
                        label: '',
                        data: [],
                        backgroundColor: Charts.colors.theme['primary'],
                        yAxisID: 'y-axis-count'
                    },
                    {
                        type: 'bar',
                        label: '',
                        data: [],
                        backgroundColor: Charts.colors.theme['success'],
                        yAxisID: 'y-axis-count'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {stacked: false},
                    'y-axis-temp': {
                        type: 'linear',
                        position: 'left',
                        ticks: {
                            callback: function (value) {
                                return value + '°C';
                            }
                        }
                    },
                    'y-axis-count': {
                        type: 'linear',
                        position: 'right',
                        stacked: false,
                        ticks: {
                            beginAtZero: true
                        }
                    }
                }
            }
        });

        // 체감 범주 차트 초기화
        var ctxx = document.getElementById('chart-perceived').getContext('2d');
        var canvasElement = document.getElementById('chart-perceived');
        console.log("Canvas element size:", canvasElement.offsetWidth, canvasElement.offsetHeight);

        perceivedChart = new Chart(ctxx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: '체감 온도 vs 체감 범주',
                        data: [], // 초기 데이터 없음
                        backgroundColor: Charts.colors.theme['primary'],
                        borderColor: Charts.colors.theme['default'],
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true, // 반응형 활성화
                maintainAspectRatio: true, // 비율 유지 비활성화
                scales: {
                    x: {
                        type: 'category',
                        labels: [], // 초기에는 빈 배열
                        title: {
                            display: true,
                            text: '체감 범주'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '체감 온도 (°C)'
                        },
                        ticks: {
                            callback: function (value) {
                                return value + '°C'; // °C 단위 추가
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        // 초기 데이터 로드
        updatePerceivedChart();
        updateChart(0);
    });

    // 새로운 차트 업데이트 함수
    function updatePerceivedChart() {
        console.log("updatePerceivedChart 호출됨");

        $.ajax({
            url: '/dashboard/chart-data2',
            method: 'GET',
            success: function (response) {
                console.log("서버 응답 데이터:", response);

                // 체감 범주 사용자 지정 정렬 순서
                const categoryOrder = ["매우 추움", "추움", "조금 추움", "선선", "보통", "따뜻", "조금 따뜻", "조금 더움", "더움", "매우 더움"];

                // 데이터를 사용자 지정 순서로 정렬
                const sortedData = response.sort((a, b) => {
                    return categoryOrder.indexOf(a.tag) - categoryOrder.indexOf(b.tag);
                });

                const categories = [...new Set(response.map(item => item.tag))];
                const dataPoints = response.map(item => ({
                    x: item.tag,
                    y: item.windChillTemp
                }));

                console.log("X축 범주:", categories);
                console.log("데이터 포인트:", dataPoints);

                // 기존 차트가 있으면 삭제
                if (perceivedChart) {
                    perceivedChart.destroy();
                }

                // 차트 다시 생성
                const ctxx = document.getElementById('chart-perceived').getContext('2d');
                perceivedChart = new Chart(ctxx, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: '체감 온도 vs 체감 범주',
                                data: dataPoints,
                                backgroundColor: Charts.colors.theme['primary'],
                                borderColor: Charts.colors.theme['default'],
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                type: 'category',
                                labels: categories,
                                title: {
                                    display: true,
                                    text: '체감 범주'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '체감 온도 (°C)'
                                },
                                ticks: {
                                    callback: function (value) {
                                        return value + '°C';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        }
                    }
                });

                console.log("Chart updated.");
            },
            error: function (xhr) {
                console.error("AJAX 요청 실패:", xhr.responseText);
            }
        });
    }

    // 버튼 클릭 이벤트 핸들러
    function updateChart(sensitivity) {
        $.ajax({
            url: '/dashboard/chart-data',
            method: 'GET',
            data: {sensitivity: sensitivity},
            success: function (response) {
                chartLine.data.labels = response.times;
                chartLine.data.datasets[0].data = response.temps;
                chartLine.data.datasets[1].data = response.tagData1;
                chartLine.data.datasets[2].data = response.tagData2;
                chartLine.data.datasets[3].data = response.tagData3;

                chartLine.data.datasets[1].label = response.tag1;
                chartLine.data.datasets[2].label = response.tag2;
                chartLine.data.datasets[3].label = response.tag3;

                chartLine.update();
            },
            error: function (xhr) {
                console.error('Error fetching chart data:', xhr.responseText);
            }
        });
    }
</script>


</body>

</html>
